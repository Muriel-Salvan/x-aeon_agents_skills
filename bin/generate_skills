#!/usr/bin/env ruby

# Executable to generate skill files from ERB templates.

require 'erb'
require 'fileutils'
require 'pathname'
require 'thor'
require 'x-aeon_agents_skills/gen_helpers'

class GenerateSkillsCLI < Thor

  # Define possible transformations based on the file extension
  TRANSFORMATIONS = {
    '.erb' => proc { |src_file| XAeonAgentsSkills::GenHelpers::ErbEvaluator.new(src_file).result }
  }
  
  desc 'generate', 'Generate skills (default task)'
  option :output_dir, type: :string, default: 'skills', desc: 'Output directory for generated skills'
  def generate
    # Define source and destination directories
    src_dir = File.expand_path('skills.src')
    src_pathname = Pathname.new(src_dir)
    dest_dir = File.expand_path(options['output_dir'])

    # Create the destination directory if it doesn't exist
    FileUtils.mkdir_p(dest_dir)

    failed = false
    Dir.glob(File.join(src_dir, '**', '*'), File::FNM_DOTMATCH).
      select { |f| File.file?(f) && File.basename(f) != '.skill_config.yml' }.
      each do |src_file|
        # Calculate the relative path from source directory
        relative_path = Pathname.new(src_file).relative_path_from(src_pathname).to_s

        file_ext = File.extname(relative_path)
        dst_file = File.join(dest_dir, TRANSFORMATIONS.key?(file_ext) ? relative_path.sub(/#{Regexp.escape(file_ext)}$/, '') : relative_path)
        puts "Processing: #{relative_path}"
        puts "    Output: #{dst_file}"
        begin
          FileUtils.mkdir_p(File.dirname(dst_file))
          if TRANSFORMATIONS.key?(file_ext)
            File.write(dst_file, TRANSFORMATIONS[file_ext].call(src_file))
          else
            FileUtils.cp(src_file, dst_file)
          end
          puts '    Status: ✓ Processed successfully'
        rescue StandardError => e
          puts "    Status: ✗ Error - #{e.message}\n    #{e.backtrace.first}"
          failed = true
        end
        puts
      end

    puts
    if failed
      puts 'Skills generated with some errors (see above).'
      exit 1
    else
      puts 'Skills generated successfully.'
    end
  end
  default_task :generate

end

GenerateSkillsCLI.start(ARGV)
